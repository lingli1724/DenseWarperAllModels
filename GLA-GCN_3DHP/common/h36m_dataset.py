# Copyright (c) 2018-present, Facebook, Inc.
# All rights reserved.
#
# This source code is licensed under the license found in the
# LICENSE file in the root directory of this source tree.
#

import numpy as np
import copy
from common.skeleton import Skeleton
from common.mocap_dataset import MocapDataset
from common.camera import normalize_screen_coordinates, image_coordinates
       
h36m_skeleton = Skeleton(parents=[-1,  0,  1,  2,  3,  4,  0,  6,  7,  8,  9,  0, 11, 12, 13, 14, 12,
       16, 17, 18, 19, 20, 19, 22, 12, 24, 25, 26, 27, 28, 27, 30],
       joints_left=[6, 7, 8, 9, 10, 16, 17, 18, 19, 20, 21, 22, 23],
       joints_right=[1, 2, 3, 4, 5, 24, 25, 26, 27, 28, 29, 30, 31])

h36m_cameras_intrinsic_params = [
    {
        'id': 0,
        'center': [1024.704, 1051.394],
        'focal_length': [1497.693, 1497.103],
        'radial_distortion': [0, 0, 0],
        'tangential_distortion': [0, 0],
        'res_w': 2048,
        'res_h': 2048,
        'azimuth': 70,
    },
    {
        'id': 2,
        'center': [983.8873, 987.5902],
        'focal_length': [1495.587, 1497.828],
        'radial_distortion': [0, 0, 0],
        'tangential_distortion': [0, 0],
        'res_w': 2048,
        'res_h': 2048,
        'azimuth': -70,
    },
    {
        'id': 7,
        'center': [987.2716, 976.8773],
        'focal_length': [1498.831, 1499.674],
        'radial_distortion': [0, 0, 0],
        'tangential_distortion': [0, 0],
        'res_w': 2048,
        'res_h': 2048,
        'azimuth': 110,
    },
    {
        'id': 8,
        'center': [1017.387, 1043.032],
        'focal_length': [1500.172, 1500.837],
        'radial_distortion': [0, 0, 0],
        'tangential_distortion': [0, 0],
        'res_w': 2048,
        'res_h': 2048,
        'azimuth': -110,
    },
]

h36m_cameras_extrinsic_params = {
    'S1': [
        {
            'orientation':  [-0.01770904350837586, -0.9910573166088837, -9.884998207855802e-05, -0.13225647508798336],
            'translation': [-460.5181309796322, 1535.1395614608819, 3813.8674075293],
        },
        {
            'orientation': [-0.014891547834199591, -0.5651276837137156, 0.030120115083483195, -0.8243189440810094],
            'translation':  [-2508.798445033742, 1491.0345390528992, -1016.87194279559],
        },
        {
            'orientation': [-0.014229200561635345, -0.0008599880416319325, -0.012334403918499314, -0.9998223105891968],
            'translation': [1408.987485243034, 1165.7754801641902, -2664.023904086498],
        },
        {
            'orientation': [-0.05232858510141386, -0.7053717990347235, -0.09563199705039459, 0.7004047868539698],
            'translation': [3427.285464078942, 1387.858243822345, 309.41951698917],
        },
    ],
    'S2': [
        {
            'orientation':  [-0.01770904350837586, -0.9910573166088837, -9.884998207855802e-05, -0.13225647508798336],
            'translation': [-460.5181309796322, 1535.1395614608819, 3813.8674075293],
        },
        {
            'orientation': [-0.014891547834199591, -0.5651276837137156, 0.030120115083483195, -0.8243189440810094],
            'translation':  [-2508.798445033742, 1491.0345390528992, -1016.87194279559],
        },
        {
            'orientation': [-0.014229200561635345, -0.0008599880416319325, -0.012334403918499314, -0.9998223105891968],
            'translation': [1408.987485243034, 1165.7754801641902, -2664.023904086498],
        },
        {
            'orientation': [-0.05232858510141386, -0.7053717990347235, -0.09563199705039459, 0.7004047868539698],
            'translation': [3427.285464078942, 1387.858243822345, 309.41951698917],
        },
    ],
    'S3': [
        {
            'orientation':  [-0.01770904350837586, -0.9910573166088837, -9.884998207855802e-05, -0.13225647508798336],
            'translation': [-460.5181309796322, 1535.1395614608819, 3813.8674075293],
        },
        {
            'orientation': [-0.014891547834199591, -0.5651276837137156, 0.030120115083483195, -0.8243189440810094],
            'translation':  [-2508.798445033742, 1491.0345390528992, -1016.87194279559],
        },
        {
            'orientation': [-0.014229200561635345, -0.0008599880416319325, -0.012334403918499314, -0.9998223105891968],
            'translation': [1408.987485243034, 1165.7754801641902, -2664.023904086498],
        },
        {
            'orientation': [-0.05232858510141386, -0.7053717990347235, -0.09563199705039459, 0.7004047868539698],
            'translation': [3427.285464078942, 1387.858243822345, 309.41951698917],
        },
    ],
    'S4': [
        {
            'orientation':  [-0.01770904350837586, -0.9910573166088837, -9.884998207855802e-05, -0.13225647508798336],
            'translation': [-460.5181309796322, 1535.1395614608819, 3813.8674075293],
        },
        {
            'orientation': [-0.014891547834199591, -0.5651276837137156, 0.030120115083483195, -0.8243189440810094],
            'translation':  [-2508.798445033742, 1491.0345390528992, -1016.87194279559],
        },
        {
            'orientation': [-0.014229200561635345, -0.0008599880416319325, -0.012334403918499314, -0.9998223105891968],
            'translation': [1408.987485243034, 1165.7754801641902, -2664.023904086498],
        },
        {
            'orientation': [-0.05232858510141386, -0.7053717990347235, -0.09563199705039459, 0.7004047868539698],
            'translation': [3427.285464078942, 1387.858243822345, 309.41951698917],
        },
    ],
    'S5': [
        {
            'orientation':  [-0.01770904350837586, -0.9910573166088837, -9.884998207855802e-05, -0.13225647508798336],
            'translation': [-460.5181309796322, 1535.1395614608819, 3813.8674075293],
        },
        {
            'orientation': [-0.014891547834199591, -0.5651276837137156, 0.030120115083483195, -0.8243189440810094],
            'translation':  [-2508.798445033742, 1491.0345390528992, -1016.87194279559],
        },
        {
            'orientation': [-0.014229200561635345, -0.0008599880416319325, -0.012334403918499314, -0.9998223105891968],
            'translation': [1408.987485243034, 1165.7754801641902, -2664.023904086498],
        },
        {
            'orientation': [-0.05232858510141386, -0.7053717990347235, -0.09563199705039459, 0.7004047868539698],
            'translation': [3427.285464078942, 1387.858243822345, 309.41951698917],
        },
    ],
    'S6': [
        {
            'orientation':  [-0.01770904350837586, -0.9910573166088837, -9.884998207855802e-05, -0.13225647508798336],
            'translation': [-460.5181309796322, 1535.1395614608819, 3813.8674075293],
        },
        {
            'orientation': [-0.014891547834199591, -0.5651276837137156, 0.030120115083483195, -0.8243189440810094],
            'translation':  [-2508.798445033742, 1491.0345390528992, -1016.87194279559],
        },
        {
            'orientation': [-0.014229200561635345, -0.0008599880416319325, -0.012334403918499314, -0.9998223105891968],
            'translation': [1408.987485243034, 1165.7754801641902, -2664.023904086498],
        },
        {
            'orientation': [-0.05232858510141386, -0.7053717990347235, -0.09563199705039459, 0.7004047868539698],
            'translation': [3427.285464078942, 1387.858243822345, 309.41951698917],
        },
    ],
    'S7': [
        {
            'orientation':  [-0.01770904350837586, -0.9910573166088837, -9.884998207855802e-05, -0.13225647508798336],
            'translation': [-460.5181309796322, 1535.1395614608819, 3813.8674075293],
        },
        {
            'orientation': [-0.014891547834199591, -0.5651276837137156, 0.030120115083483195, -0.8243189440810094],
            'translation':  [-2508.798445033742, 1491.0345390528992, -1016.87194279559],
        },
        {
            'orientation': [-0.014229200561635345, -0.0008599880416319325, -0.012334403918499314, -0.9998223105891968],
            'translation': [1408.987485243034, 1165.7754801641902, -2664.023904086498],
        },
        {
            'orientation': [-0.05232858510141386, -0.7053717990347235, -0.09563199705039459, 0.7004047868539698],
            'translation': [3427.285464078942, 1387.858243822345, 309.41951698917],
        },
    ],
    'S8': [
        {
            'orientation':  [-0.01770904350837586, -0.9910573166088837, -9.884998207855802e-05, -0.13225647508798336],
            'translation': [-460.5181309796322, 1535.1395614608819, 3813.8674075293],
        },
        {
            'orientation': [-0.014891547834199591, -0.5651276837137156, 0.030120115083483195, -0.8243189440810094],
            'translation':  [-2508.798445033742, 1491.0345390528992, -1016.87194279559],
        },
        {
            'orientation': [-0.014229200561635345, -0.0008599880416319325, -0.012334403918499314, -0.9998223105891968],
            'translation': [1408.987485243034, 1165.7754801641902, -2664.023904086498],
        },
        {
            'orientation': [-0.05232858510141386, -0.7053717990347235, -0.09563199705039459, 0.7004047868539698],
            'translation': [3427.285464078942, 1387.858243822345, 309.41951698917],
        },
    ],
}

class Human36mDataset(MocapDataset):
    def __init__(self, path, remove_static_joints=True):
        super().__init__(fps=50, skeleton=h36m_skeleton)
        
        self._cameras = copy.deepcopy(h36m_cameras_extrinsic_params)
        for cameras in self._cameras.values():
            for i, cam in enumerate(cameras):
                cam.update(h36m_cameras_intrinsic_params[i])
                for k, v in cam.items():
                    if k not in ['id', 'res_w', 'res_h']:
                        cam[k] = np.array(v, dtype='float32')
                
                # Normalize camera frame
                cam['center'] = normalize_screen_coordinates(cam['center'], w=cam['res_w'], h=cam['res_h']).astype('float32')
                cam['focal_length'] = cam['focal_length']/cam['res_w']*2
                if 'translation' in cam:
                    cam['translation'] = cam['translation']/1000 # mm to meters
                
                # Add intrinsic parameters vector
                cam['intrinsic'] = np.concatenate((cam['focal_length'],
                                                   cam['center'],
                                                   cam['radial_distortion'],
                                                   cam['tangential_distortion']))
        
        # Load serialized dataset
        data = np.load(path, allow_pickle=True)['positions_3d'].item()
        
        self._data = {}
        for subject, actions in data.items():
            self._data[subject] = {}
            for action_name, positions in actions.items():
                self._data[subject][action_name] = {
                    'positions': positions,
                    'cameras': self._cameras[subject],
                }
                
        if remove_static_joints:
            # Bring the skeleton to 17 joints instead of the original 32
            self.remove_joints([4, 5, 9, 10, 11, 16, 20, 21, 22, 23, 24, 28, 29, 30, 31])
            
            # Rewire shoulders to the correct parents
            self._skeleton._parents[11] = 8
            self._skeleton._parents[14] = 8
            
    def supports_semi_supervised(self):
        return True

    def define_actions(self):
        all_actions = ["seq1",
                       "seq2",
                       ]

        return all_actions
